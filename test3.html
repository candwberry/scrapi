<!-- Green Background -->
<div id="tiling-carousel" style="margin-top: 48px;">
    <div class="carousel-container">
        <div class="flex flex-row justify-between mb-4 items-center">
            <p class="text-2xl font-bold text-white ">Suggested Products</p>
            <div class="flex flex-row gap-4">
                <button class="prevBtn w-10 h-10 bg-white rounded-full flex items-center justify-center"
                    style="color: #009845;">&#10094;</button>
                <button class="nextBtn w-10 h-10 bg-white rounded-full flex items-center justify-center"
                    style="color: #009845">&#10095;</button>
            </div>
        </div>
        <div class="carousel">
        </div>
    </div>
</div>

<!-- Grey background -->
<div id="floorboards-carousel" style="margin-top: 48px;">
    <div class="carousel-container">
        <div class="flex flex-row justify-between mb-4 items-center">
            <p class="text-2xl font-bold text-black ">Suggested Products</p>
            <div class="flex flex-row gap-4">
                <button class="prevBtn w-10 h-10 rounded-full flex items-center justify-center"
                    style="background-color: #009845; color: #fff;">&#10094;</button>
                <button class="nextBtn w-10 h-10 bg-green rounded-full flex items-center justify-center"
                    style="background-color: #009845; color: #fff;">&#10095;</button>
            </div>
        </div>
        <div class="carousel">
        </div>
    </div>
</div>

<!-- White background -->
<div id="floorboards-carousel" style="margin-top: 48px;">
    <div class="carousel-container">
        <div class="flex flex-row justify-between mb-4 items-center">
            <p class="text-2xl font-bold text-black ">Suggested Products</p>
            <div class="flex flex-row gap-4">
                <button class="prevBtn w-10 h-10 rounded-full flex items-center justify-center"
                    style="background-color: #009845; color: #fff;">&#10094;</button>
                <button class="nextBtn w-10 h-10 bg-green rounded-full flex items-center justify-center"
                    style="background-color: #009845; color: #fff;">&#10095;</button>
            </div>
        </div>
        <div class="carousel">
        </div>
    </div>
</div>

<script>
    window.addEventListener('DOMContentLoaded', async (event) => {
        const materials = ["aggregates", "bricks-and-blocks", "tiling", "floorboards", "insulation", "paving", "radiators", "timber-decking"];
        
        materials.forEach(material => {
            console.log(material);
            console.log(document.getElementsByClassName(`${material}-products`));
            console.log(document.getElementById(`${material}-carousel`));
            if (document.getElementsByClassName(`${material}-products`).length == 0 || !document.getElementById(`${material}-carousel`)) {
                materials.splice(materials.indexOf(material), 1);
            }
        });
        console.log(materials);

        const whites = ["floorboards", "radiators"];

        const vat = document.getElementById("exvat");

        function getPriceElement(product, isExVat) {
            return !isExVat ? product.priceEx : product.priceInc;
        }

        const sections = materials.map(material => {
            return document.getElementById(`${material}-carousel`);
        });

        const carousels = [];
        const prevBtns = [];
        const nextBtns = [];
        const carouselContainers = [];

        for (let i = 0; i < sections.length; i++) {
            const section = sections[i];

            carousels.push(section.querySelector(`.carousel`));
            prevBtns.push(section.querySelector(`.prevBtn`));
            nextBtns.push(section.querySelector(`.nextBtn`));
            carouselContainers.push(section.querySelector(`.carousel-container`));
        }

        const productsMap = {};
        const formsMap = {};
        for (let i = 0; i < materials.length; i++) {
            const material = materials[i];
            formsMap[material] = document.getElementsByClassName(`${material}-products`)[0].querySelectorAll("form.product_addtocart_form");
        }

        for (let i = 0; i < materials.length; i++) {
            const material = materials[i];
            const forms = formsMap[material];
            const products = [];
            for (let i = 0; i < forms.length; i++) {
                const form = forms[i];
                let title = form.querySelector(".product-item-link").textContent.trim();
                const image = form.querySelector(".product-item-photo img").src;
                const priceInc = form.querySelector(".price-including-tax");
                const priceEx = form.querySelector(".price-excluding-tax");
                const href = form.querySelector("a").href;
                const label = (((form.querySelector(".price-label") ?? {}).textContent) ?? "").trim();
                const action = form.action;

                const product = {
                    name: title,
                    image: image,
                    priceInc: priceInc,
                    priceEx: priceEx,
                    href: href,
                    action: action,
                    label: label ?? ""
                };
                products.push(product);
            }

            productsMap[material] = products;
        }

        function updatePrices(isExVat) {
            for (let i = 0; i < materials.length; i++) {
                const material = materials[i];
                const products = productsMap[material];
                products.forEach((product, index) => {
                    const priceElement = document.getElementById(`${material}${index}price`);
                    if (priceElement) {
                        priceElement.innerHTML = product.label + " " + getPriceElement(product, isExVat).innerHTML;
                    }
                });
            }
        }

        for (let i = 0; i < materials.length; i++) {
            const carousel = carousels[i];
            const material = materials[i];
            const products = productsMap[material];

            products.forEach((product, index) => {
                const item = document.createElement('div');
                item.className = 'carousel-item';
                item.innerHTML = `
    <form method="POST" action="${product.action}" class="carousel-item-content w-full" style="${whites.includes(material) ? 'background-color: #e2e2e2' : ''}">
      <input name="form_key" type="hidden" value="&lt;?php echo Mage::getSingleton('core/session')-&gt;getFormKey() ?&gt;">
      <img src="${product.image}" alt="${product.name}" title="${product.name}" class="carousel-item-image">
      <div class="carousel-item-details w-full">
        <div>
          <p class="product-title">${product.name}</p>
          <strong>
          <span id="${material}${index}price"></span>
          </strong>
        </div>
        <div>
          <div class="md:mt-auto pt-2 pb-2 flex w-full z-50">
            <button type="submit" class="w-full py-2 btn btn-primary justify-center text-sm rounded uppercase font-bold focus:border-primary focus:outline-none focus:ring-0 mr-auto" aria-label="Add to Basket">
              <svg width="23" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 328.8">
                <path style="fill:#fff" d="M387.61,142.63h-116.59l-27.11-61.22c3.52-3.46,4.83-8.84,2.9-13.69l-21.21-53.51c-5.22-11.89-17.75-17.11-26.2-12.32l-1.1-.44c-10.5-4.17-20.52,1.02-24.69,11.53l-21.21,53.5c-1.9,4.8-.64,10.1,2.77,13.55l-.26,.18-27.57,62.42H12.45c-.26,0-.52,0-.77,.02-6.5,.29-11.68,4.32-11.68,9.19v6.79c0,5.07,5.99,9.49,12.83,9.49h3.52l52.04,148.59c2.54,7.25,9.38,12.11,17.07,12.11h220.59c7.4,0,14.06-4.52,16.8-11.4l59.16-148.73h5.64c.29,0,.58,0,.86-.03,6.45-.39,11.49-5.17,11.49-10.02v-6.79c0-5.05-5.57-9.19-12.39-9.2Zm-122.93,60.13h-55.65v-34.72h61.02l-5.38,34.72Zm-7.75,50.05h-47.9v-32.17h52.88l-4.98,32.17Zm-119.42-32.17h53.04l-.06,32.17h-48.18l-4.81-32.17Zm33.86-132.76l.09-.5c5.78,1.02,11.72-2.13,13.97-7.79l13.92-35.1,14.41,36.34c2.13,5.36,7.57,8.47,13.06,7.91h0s.06,.17,.09,.28c0,.03,.02,.06,.02,.08,0,0,0,.02,0,.02l24.7,53.53h-104.82l24.55-54.76Zm19.28,80.16l-.06,34.72h-55.76l-5.2-34.72h61.01Zm-146.03,0H111.83l5.05,34.72H56.87l-12.25-34.72Zm19.4,52.6h55.46l4.69,32.17h-49.17l-10.98-32.17Zm29.87,84.25l-12.26-34.21h45.13l4.98,34.21h-37.84Zm56.22,0l-5.12-34.21h45.46l-.06,34.21h-40.28Zm58.91,0v-34.21h45.13l-5.3,34.21h-39.83Zm90.13,0h-32.17l5.39-34.21h39.54l-12.76,34.21Zm20.42-52.08h-44.38l5.08-32.17h52.59l-13.28,32.17Zm21.45-50.05h-57.94l5.47-34.72h66.76l-14.29,34.72Z">
              </path>
              </svg>
              <span class="ml-2 inline text-nowrap">
                Add to Basket
              </span>
            </button>
          </div>
          <div class="">
            <a href="${product.href}" class="text-sm font-bold border-b hover:text-primary" style="${whites.includes(material) ? 'border-color: black' : ''}"
            >VIEW PRODUCT</a>
          </div>
        </div>
      </div>
    </form>
  `;
                carousel.appendChild(item);
                const priceElement = item.querySelector(`#${material}${index}price`);
                priceElement.innerHTML = product.label + " " + getPriceElement(product, vat.checked).innerHTML;

            });
        };

        const carouselIndexMap = {};
        materials.forEach((material, index) => {
            carouselIndexMap[material] = 0;
        });

        function getVisibleItems() {
            if (window.innerWidth <= 880) {
                return 1;
            } else if (window.innerWidth <= 1280) {
                return 2;
            } else {
                return 3;
            }
        }

        function updateCarousel(material) {
            const visibleItems = getVisibleItems();
            const itemWidth = 100 / visibleItems;

            let offset = carouselIndexMap[material] * itemWidth;
            const carousel = carousels[materials.indexOf(material)];
            carousel.style.transform = `translateX(-${offset}%)`;
        }

        function nextProduct(material) {
            if (carouselIndexMap[material] < productsMap[material].length - getVisibleItems()) {
                carouselIndexMap[material]++;
                updateCarousel(material);
            }
        }

        function prevProduct(material) {
            if (carouselIndexMap[material] > 0) {
                carouselIndexMap[material]--;
                updateCarousel(material);
            }
        }

        materials.forEach((material, index) => {
            prevBtns[index].addEventListener('click', () => prevProduct(material));
            nextBtns[index].addEventListener('click', () => nextProduct(material));
        });

        vat.addEventListener('change', (event) => {
            updatePrices(event.target.checked);
        });

        let touchStartX;
        let isSwiping = false;

        carouselContainers.forEach((carouselContainer, index) => {
            carouselContainer.addEventListener('touchstart', (e) => {
                touchStartX = e.touches[0].clientX;
                isSwiping = false;
            });

            carouselContainer.addEventListener('touchmove', (e) => {
                if (isSwiping) return;

                const touchMoveX = e.touches[0].clientX;
                const swipeDistance = touchStartX - touchMoveX;
                const swipeThreshold = window.innerWidth * 0.25;

                console.log(swipeDistance)
                console.log(swipeThreshold)
                if (Math.abs(swipeDistance) > swipeThreshold) {
                    isSwiping = true;
                    if (swipeDistance > 0) {
                        nextProduct(materials[index]);
                    } else {
                        prevProduct(materials[index]);
                    }
                }
            });

            carouselContainer.addEventListener('touchend', () => {
                isSwiping = false;
            });
        });

        function updateCarousels() {
            materials.forEach((material, index) => {
                updateCarousel(material);
            });
        }

        updateCarousels();
        window.addEventListener('resize', updateCarousels);
    });
</script>

<style>
    h2 {
        pointer-events: none;
    }

    .product-title {
        display: -webkit-box;
        line-clamp: 2;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        min-height: 2.4em;
        max-height: 2.4em; 
        line-height: 1.2em; 
    }


    .carousel-container {
        position: relative;
        width: 100%;
        overflow: hidden;
    }

    .carousel-container>button {
        font-size: 1.5rem;
        margin-right: 4px;
    }

    .carousel {
        display: flex;
        transition: transform 0.5s ease;
    }

    .carousel-item {
        flex: 0 0 33.333%;
        max-width: 33.333%;
        padding: 10px;
        box-sizing: border-box;
        height: 220px;
    }


    .carousel-item-image {
        height: 100%;
        max-width: 50%;
        object-fit: cover;
    }

    .carousel-item-content {
        display: flex;
        flex-direction: row;
        background-color: white;
        padding: 1rem;
        border-radius: 0.5rem;
        height: 100%;
        width: 100%;
    }

    .carousel-item-details {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        padding-left: 1rem;
    }

    @media (max-width: 1280px) {
        .carousel-item {
            flex: 0 0 50%;
            max-width: 50%;
        }
    }

    @media (max-width: 880px) {
        .carousel-item {
            flex: 0 0 100%;
            max-width: 100%;
        }

        .carousel {
            max-width: 500px;
        }
    }


    @media (max-width: 480px) {
        .carousel-item-image {
            height: 70%;
            align-self: center;
        }

        .carousel-item-details {
            font-size: 0.8rem;
        }

        .carousel-item-details button {
            padding: 0.5rem;
            font-size: 0.7rem;
        }

        .carousel-item-details a {
            font-size: 0.7rem;
        }

        .carousel-item {
            height: 180px;
        }
    }
</style>